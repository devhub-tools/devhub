defmodule Devhub.Users.Actions.RegisterPasskeyTest do
  use Devhub.DataCase, async: true

  alias Devhub.Users
  alias Devhub.Users.Schemas.Passkey

  test "success" do
    user = insert(:user)

    raw_id = "2fomAYPOXkoe32isN3nAuotahwQ="

    public_key =
      <<131, 116, 0, 0, 0, 5, 98, 255, 255, 255, 253, 109, 0, 0, 0, 32, 132, 222, 200, 238, 247, 32, 161, 225, 36, 242,
        225, 133, 132, 242, 47, 31, 121, 236, 222, 242, 215, 136, 130, 82, 184, 68, 205, 128, 48, 12, 231, 247, 98, 255,
        255, 255, 254, 109, 0, 0, 0, 32, 49, 100, 36, 179, 43, 188, 51, 86, 176, 36, 146, 165, 149, 10, 176, 51, 251, 141,
        149, 48, 115, 18, 147, 195, 10, 31, 122, 190, 162, 230, 156, 77, 98, 255, 255, 255, 255, 97, 1, 97, 1, 97, 2, 97,
        3, 98, 255, 255, 255, 249>>

    aaguid = <<251, 252, 48, 7, 21, 78, 78, 204, 140, 11, 110, 2, 5, 87, 215, 189>>

    assert {:ok,
            %Passkey{
              raw_id: ^raw_id,
              public_key: ^public_key,
              aaguid: ^aaguid
            }} =
             Users.register_passkey(user, %{
               raw_id: raw_id,
               public_key:
                 <<131, 116, 0, 0, 0, 5, 98, 255, 255, 255, 253, 109, 0, 0, 0, 32, 132, 222, 200, 238, 247, 32, 161, 225,
                   36, 242, 225, 133, 132, 242, 47, 31, 121, 236, 222, 242, 215, 136, 130, 82, 184, 68, 205, 128, 48, 12,
                   231, 247, 98, 255, 255, 255, 254, 109, 0, 0, 0, 32, 49, 100, 36, 179, 43, 188, 51, 86, 176, 36, 146,
                   165, 149, 10, 176, 51, 251, 141, 149, 48, 115, 18, 147, 195, 10, 31, 122, 190, 162, 230, 156, 77, 98,
                   255, 255, 255, 255, 97, 1, 97, 1, 97, 2, 97, 3, 98, 255, 255, 255, 249>>,
               aaguid: aaguid
             })
  end
end
